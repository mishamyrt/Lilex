---
import Typography from "../../components/Typography.astro";

export type Props = {
	text: string;
};

const { text } = Astro.props;
---

<div class="preview">
	<Typography as="h2" variant="text-m_accent" color="secondary">
		Text
	</Typography>
	<textarea class="preview-textarea" spellcheck="false">{text}</textarea>
</div>

<script>
	import { $glyphsSize } from "../../stores/glyphs";
	const TAB_CHAR = "\t"; // одиночный таб-символ
	const root = document?.querySelector<HTMLDivElement>(".preview");
	const textarea =
		root?.querySelector<HTMLTextAreaElement>(".preview-textarea");
	if (!textarea) {
		throw new Error("Textarea element not found");
	}

	function autoResize() {
		if (!textarea) return;
		textarea.style.height = "auto";
		textarea.style.height = `${textarea.scrollHeight}px`;
	}

	if (textarea) {
		textarea.addEventListener("input", autoResize);
		autoResize(); // Initial resize

		const unsubscribeGlyphsSize = $glyphsSize.subscribe(() => {
			autoResize();
		});

		const cleanup = () => {
			unsubscribeGlyphsSize();
			window.removeEventListener("astro:before-swap", cleanup);
			window.removeEventListener("beforeunload", cleanup);
		};

		window.addEventListener("astro:before-swap", cleanup);
		window.addEventListener("beforeunload", cleanup);

		textarea.addEventListener("keydown", (event) => {
			if (event.key === "Tab") {
				event.preventDefault();

				// Preserve window scroll to avoid jump on value/size updates
				const prevScrollX = window.scrollX;
				const prevScrollY = window.scrollY;

				const start = textarea.selectionStart;
				const end = textarea.selectionEnd;
				const value = textarea.value;

				if (event.shiftKey) {
					// Shift+Tab: удалить видимый таб-символ или 4 пробела в начале строк
					const lines = value.split("\n");
					const startLine = value.substring(0, start).split("\n").length - 1;
					const endLine = value.substring(0, end).split("\n").length - 1;

					let removedCount = 0;
					let firstRemovedDelta = 0;

					for (let i = startLine; i <= endLine; i++) {
					if (!lines[i]) continue;
					if (lines[i].startsWith(TAB_CHAR)) {
						lines[i] = lines[i].slice(TAB_CHAR.length);
						removedCount += TAB_CHAR.length;
						if (i === startLine) firstRemovedDelta = TAB_CHAR.length;
						} else if (lines[i].startsWith("    ")) {
							// Поддержка старых 4 пробелов
							lines[i] = lines[i].substring(4);
							removedCount += 4;
							if (i === startLine) firstRemovedDelta = 4;
						}
					}

					if (removedCount > 0) {
						const newValue = lines.join("\n");
						textarea.value = newValue;

						// Пересчитываем позиции курсора
						const beforeStart = value.substring(0, start);
						const lineStart = beforeStart.lastIndexOf("\n") + 1;
						const newStart = firstRemovedDelta > 0
							? Math.max(lineStart, start - firstRemovedDelta)
							: start;

						const newEnd = end - removedCount;
						textarea.setSelectionRange(newStart, newEnd);
						autoResize();
					}
				} else {
					// Tab: вставить таб-символ (ширина управляется через CSS tab-size)
					const lines = value.split("\n");
					const startLine = value.substring(0, start).split("\n").length - 1;
					const endLine = value.substring(0, end).split("\n").length - 1;
					const tab = TAB_CHAR;

					// Если выделено несколько строк - добавляем символ в начале каждой
					if (startLine !== endLine || start !== end) {
						let addedCount = 0;
						for (let i = startLine; i <= endLine; i++) {
							if (lines[i] !== undefined) {
								lines[i] = tab + lines[i];
								addedCount += tab.length;
							}
						}
						const newValue = lines.join("\n");
						textarea.value = newValue;
						textarea.setSelectionRange(start + tab.length, end + addedCount);
					} else {
						// Одна строка - вставляем символ в позицию курсора
						const newValue =
							value.substring(0, start) + tab + value.substring(end);
						textarea.value = newValue;
						textarea.setSelectionRange(start + tab.length, start + tab.length);
					}
					autoResize();
				}

				// Restore scroll position on next frame after layout settles
				requestAnimationFrame(() => {
					window.scrollTo(prevScrollX, prevScrollY);
				});
			}
		});
	}
</script>

<style lang="scss">
	.preview {
		--preview-weight: 400;

		width: 100%;
	}

	textarea {
		width: 100%;
		margin: 0;
		margin-top: var(--space-xs);
		min-height: 290px;
		padding: 0;
		resize: none;
		border: none;
		outline: none;
		background: transparent;
		color: var(--color-content-primary);
		font-family: "LilexWeb";
		font-size: var(--glyphs-size);
		line-height: 1.5;
		font-variation-settings: "wght" var(--glyph-weight, 400);
		font-feature-settings: "liga";
		white-space: pre-wrap;
		tab-size: 4;
		-moz-tab-size: 4;
		overflow: hidden;
	}

	:global(.glyphs-italic) .preview-textarea {
		font-style: italic;
	}

	.preview-textarea._italic {
		font-style: italic;
	}
</style>
